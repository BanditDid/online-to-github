<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <title>Antigravity Karaoke - Host</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body class="host-page">
    <div class="fullscreen-player">
        <div id="player-wrapper">
            <div id="player"></div>
            <div class="video-overlay"></div>
        </div>

        <!-- Controls Overlay -->
        <div class="player-controls">
            <!-- Time Display Row -->
            <div class="time-row">
                <span class="time-current" id="time-current">0:00</span>
                <span class="time-duration" id="time-duration">0:00</span>
            </div>

            <div class="progress-bar-container" id="progress-container">
                <div class="progress-fill" id="progress-fill"></div>
            </div>

            <!-- Desktop Control Bar -->
            <div class="control-bar control-bar-desktop">
                <div class="control-left">
                    <button id="main-play-pause" class="play-pause-circle">
                        <span id="play-pause-icon">||</span>
                    </button>
                    <button class="btn-icon-sub" id="btn-loop" title="Loop">
                        <svg viewBox="0 0 24 24" fill="white" width="22" height="22">
                            <path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z" />
                        </svg>
                    </button>
                    <button class="btn-icon-sub" id="btn-skip-desktop" onclick="skipToNext()" title="Skip">
                        <svg viewBox="0 0 24 24" fill="white" width="22" height="22">
                            <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z" />
                        </svg>
                    </button>
                </div>

                <div class="control-center">
                    <div class="track-meta">
                        <h4 id="current-title">Welcome to Karaoke</h4>
                        <p id="current-artist">Select a song to start</p>
                    </div>
                </div>

                <div class="control-right">
                    <div class="volume-box">
                        <svg viewBox="0 0 24 24" fill="white" width="20" height="20">
                            <path
                                d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" />
                        </svg>
                        <input type="range" id="volume-range" min="0" max="100" value="100">
                    </div>
                    <button class="btn-icon-sub" onclick="openSearchModal()" title="Search">
                        <svg viewBox="0 0 24 24" fill="white" width="22" height="22">
                            <path
                                d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                        </svg>
                    </button>
                    <button class="btn-icon-sub" onclick="togglePanel('queue')" title="Queue">
                        <svg viewBox="0 0 24 24" fill="white" width="22" height="22">
                            <path d="M4 10h12v2H4zm0-4h12v2H4zm0 8h8v2H4zm10 0v6l5-3z" />
                        </svg>
                    </button>
                    <button class="btn-icon-sub" onclick="openRemoteModal()" title="Room Info">
                        <svg viewBox="0 0 24 24" fill="white" width="22" height="22">
                            <path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z" />
                        </svg>
                    </button>
                    <button class="btn-icon-sub" onclick="toggleFullscreen()" title="Fullscreen">
                        <svg viewBox="0 0 24 24" fill="white" width="22" height="22">
                            <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Mobile Control Bar -->
            <div class="control-bar control-bar-mobile">
                <button id="main-play-pause-mobile" class="play-pause-circle" onclick="togglePlayPause()">
                    <svg id="play-icon-mobile" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </button>
                <button class="btn-icon-sub" id="btn-loop-mobile" title="Loop">
                    <svg viewBox="0 0 24 24" fill="white" width="24" height="24">
                        <path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z" />
                    </svg>
                </button>
                <button class="btn-icon-sub" onclick="skipToNext()" title="Skip">
                    <svg viewBox="0 0 24 24" fill="white" width="24" height="24">
                        <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z" />
                    </svg>
                </button>
                <button class="btn-icon-sub" onclick="openSearchModal()" title="Search">
                    <svg viewBox="0 0 24 24" fill="white" width="24" height="24">
                        <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                    </svg>
                </button>
                <button class="btn-icon-sub" onclick="togglePanel('queue')" title="Queue">
                    <svg viewBox="0 0 24 24" fill="white" width="24" height="24">
                        <path d="M4 10h12v2H4zm0-4h12v2H4zm0 8h8v2H4zm10 0v6l5-3z" />
                    </svg>
                </button>
                <button class="btn-icon-sub" onclick="openRemoteModal()" title="Room Info">
                    <svg viewBox="0 0 24 24" fill="white" width="24" height="24">
                        <path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z" />
                    </svg>
                </button>
                <button class="btn-icon-sub" onclick="toggleFullscreen()" title="Fullscreen">
                    <svg viewBox="0 0 24 24" fill="white" width="24" height="24">
                        <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Overlays -->
        <div id="search-modal" class="search-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ค้นหาเพลงใหม่</h3>
                    <button class="btn-close" onclick="closeSearchModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"
                            stroke-linejoin="round" width="24" height="24">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="modal-search-box">
                    <input type="text" id="modal-search-input" placeholder="ค้นหาเพลง ศิลปิน หรือรหัสเพลง...">
                </div>
                <div id="modal-results-list" class="modal-results-list">
                    <!-- Search results here -->
                </div>
            </div>
        </div>
        <div id="side-panel" class="side-panel">
            <div class="panel-header-main">
                <div class="header-left">
                    <button class="btn-close-small" onclick="closePanel()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"
                            stroke-linejoin="round" width="18" height="18">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                    <div class="header-titles">
                        <h3>คิวเพลง</h3>
                        <span id="queue-count">0 เพลง</span>
                    </div>
                </div>
                <button class="btn-clear-queue" onclick="clearQueue()">ล้างคิว</button>
            </div>
            <div id="panel-content" class="panel-body">
                <!-- Content handled by updateQueueUI -->
                <div id="queue-list-display"></div>
            </div>
        </div>

        <!-- Remote Control Modal -->
        <div id="remote-modal" class="search-modal">
            <div class="modal-content remote-modal-content">
                <div class="modal-header">
                    <h3>รีโมทคอนโทรล</h3>
                    <button class="btn-close" onclick="closeRemoteModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"
                            stroke-linejoin="round" width="20" height="20">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                <p class="remote-hint">สแกน QR Code หรือใช้รหัสด้านล่างเพื่อควบคุมผ่านมือถือ</p>

                <div class="remote-qr-container">
                    <div id="qrcode"></div>
                </div>

                <div class="remote-info-grid">
                    <div class="info-item">
                        <label>รหัสผู้ใช้</label>
                        <span id="room-id-display" class="neon-text-cyan">------</span>
                    </div>
                    <div class="info-item">
                        <label>รหัสผ่าน</label>
                        <span id="room-password-display" class="neon-text-pink">85661</span>
                    </div>
                </div>

                <div class="remote-link-section">
                    <label>ลิงก์เข้าห้อง</label>
                    <div class="link-input-group">
                        <input type="text" id="remote-link-input" readonly
                            value="https://haekpak.fun/remote?u=----&p=----">
                        <button class="btn-copy-link" onclick="copyRoomLink()">คัดลอก</button>
                    </div>
                </div>

                <div class="remote-modal-footer">
                    <button class="btn-footer-gray" onclick="window.location.href='/'">กลับหน้าแรก</button>
                    <button class="btn-footer-red" onclick="resetRoom()">รีเซ็ตห้อง</button>
                </div>
            </div>
        </div>

        <!-- Scoring Overlay -->
        <div id="score-overlay">
            <div class="score-card">
                <p class="score-title">YOUR SCORE</p>
                <div class="score-value" id="final-score">0</div>
                <p>Ready for the next one?</p>
            </div>
        </div>
    </div>

    <!-- Hidden queue source for toggle -->
    <div id="queue-source" style="display: none;">
        <div id="queue-list"></div>
    </div>

    <script>
        const socket = io();
        let player;
        let currentRoomId = '';
        let currentSong = null;
        let isPlaying = false;
        let progressInterval;

        // Load YouTube IFrame API
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                videoId: '',
                playerVars: {
                    'autoplay': 1,
                    'controls': 0, // Custom controls
                    'modestbranding': 1,
                    'rel': 0,
                    'iv_load_policy': 3
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            socket.emit('create-room');

            // Progress Bar Logic
            progressInterval = setInterval(() => {
                if (player && player.getCurrentTime) {
                    const currentTime = player.getCurrentTime();
                    const duration = player.getDuration();
                    const volume = player.getVolume();

                    if (duration > 0) {
                        const percent = (currentTime / duration) * 100;
                        document.getElementById('progress-fill').style.width = percent + '%';
                        document.getElementById('time-current').innerText = formatTime(currentTime);
                        document.getElementById('time-duration').innerText = formatTime(duration);

                        // Emit state to remote
                        socket.emit('player-state', {
                            roomId: currentRoomId,
                            isPlaying,
                            volume,
                            currentTime,
                            duration
                        });
                    }
                }
            }, 1000);
        }

        function skipToNext() {
            if (currentRoomId) {
                socket.emit('request-next', currentRoomId);
            }
        }

        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return min + ":" + (sec < 10 ? "0" : "") + sec;
        }

        function onPlayerStateChange(event) {
            const icon = document.getElementById('play-pause-icon');
            const mobileIcon = document.getElementById('play-icon-mobile');
            if (event.data == YT.PlayerState.PLAYING) {
                isPlaying = true;
                icon.innerText = '||';
                if (mobileIcon) {
                    mobileIcon.innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
                }
            } else if (event.data == YT.PlayerState.PAUSED) {
                isPlaying = false;
                icon.innerText = '▶';
                if (mobileIcon) {
                    mobileIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
                }
            } else if (event.data == YT.PlayerState.ENDED) {
                showScore();
            }
        }

        // Controls
        function togglePlayPause() {
            if (isPlaying) player.pauseVideo();
            else player.playVideo();
        }

        document.getElementById('main-play-pause').onclick = togglePlayPause;

        document.getElementById('volume-range').oninput = (e) => {
            player.setVolume(e.target.value);
        };

        function toggleFullscreen() {
            const doc = window.document;
            const docEl = doc.documentElement;
            const requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
            const cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

            if (!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
                requestFullScreen.call(docEl);
            } else {
                cancelFullScreen.call(doc);
            }
        }

        function togglePanel(type) {
            const sidePanel = document.getElementById('side-panel');
            if (type === 'queue') {
                sidePanel.classList.toggle('active');
            }
        }

        function closePanel() {
            document.getElementById('side-panel').classList.remove('active');
        }

        // Search Modal Logic
        function openSearchModal() {
            document.getElementById('search-modal').classList.add('active');
            document.getElementById('modal-search-input').focus();
        }

        function closeSearchModal() {
            document.getElementById('search-modal').classList.remove('active');
        }

        async function performModalSearch() {
            const query = document.getElementById('modal-search-input').value;
            if (!query) return;

            const resultsList = document.getElementById('modal-results-list');
            resultsList.innerHTML = '<div class="loading">Searching...</div>';

            try {
                const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                const songs = await response.json();

                resultsList.innerHTML = '';
                songs.forEach(song => {
                    const card = document.createElement('div');
                    card.className = 'modal-song-card';
                    card.innerHTML = `
                        <img src="${song.thumbnail}" class="modal-song-thumb">
                        <div class="modal-song-info">
                            <h4>${song.title}</h4>
                            <p>${song.author}</p>
                        </div>
                        <button class="btn-add-modal">
                            <span class="plus-icon">+</span>
                            <span class="btn-text">เพิ่ม</span>
                        </button>
                    `;
                    card.querySelector('.btn-add-modal').onclick = () => {
                        socket.emit('add-to-queue', { roomId: currentRoomId, song });
                        closeSearchModal();
                    };
                    resultsList.appendChild(card);
                });
            } catch (error) {
                resultsList.innerHTML = '<div class="error">Search failed</div>';
            }
        }

        document.getElementById('modal-search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performModalSearch();
        });

        function clearQueue() {
            if (confirm('คุณต้องการล้างคิวเพลงทั้งหมดหรือไม่?')) {
                socket.emit('clear-queue', currentRoomId);
            }
        }

        function openRemoteModal() {
            document.getElementById('remote-modal').classList.add('active');
        }

        function closeRemoteModal() {
            document.getElementById('remote-modal').classList.remove('active');
        }

        function copyRoomLink() {
            const linkInput = document.getElementById('remote-link-input');
            linkInput.select();
            document.execCommand('copy');
            const btn = document.querySelector('.btn-copy-link');
            const originalText = btn.innerText;
            btn.innerText = 'คัดลอกแล้ว!';
            setTimeout(() => btn.innerText = originalText, 2000);
        }

        function resetRoom() {
            if (confirm('คุณต้องการรีเซ็ตห้องและล้างคิวทั้งหมดหรือไม่?')) {
                window.location.reload();
            }
        }

        socket.on('room-created', (roomId) => {
            currentRoomId = roomId;
            document.getElementById('room-id-display').innerText = roomId;

            // Generate QR Code
            const remoteUrl = `${window.location.origin}/remote.html?room=${roomId}`;
            const qrContainer = document.getElementById("qrcode");
            qrContainer.innerHTML = ''; // Clear previous
            new QRCode(qrContainer, {
                text: remoteUrl,
                width: 180,
                height: 180,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            // Update link input
            document.getElementById('remote-link-input').value = remoteUrl;
            console.log("Remote URL:", remoteUrl);

            // Handle automatic song addition from landing page
            const urlParams = new URLSearchParams(window.location.search);
            const songIdToAdd = urlParams.get('add');
            if (songIdToAdd) {
                // Remove the parameter from URL without refreshing
                window.history.replaceState({}, document.title, window.location.pathname);

                // Fetch song details and add to queue
                fetch(`/api/search?q=${songIdToAdd}`).then(res => res.json()).then(songs => {
                    const song = songs.find(s => s.id === songIdToAdd);
                    if (song) {
                        socket.emit('add-to-queue', { roomId: currentRoomId, song });
                    }
                });
            }
        });

        socket.on('queue-updated', (queue) => {
            const queueListDisplay = document.getElementById('queue-list-display');
            const queueCount = document.getElementById('queue-count');

            queueCount.innerText = `${queue.length} เพลง`;
            queueListDisplay.innerHTML = '';

            queue.forEach((song, index) => {
                const div = document.createElement('div');
                div.className = 'queue-card';
                div.innerHTML = `
                    <div class="queue-card-inner">
                        <img src="${song.thumbnail}" class="queue-card-thumb">
                        <div class="queue-card-info">
                            <h4 class="queue-card-title">${song.title}</h4>
                            <p class="queue-card-author">${song.author}</p>
                        </div>
                        <div class="queue-card-actions">
                            <button class="btn-play-now" title="เล่นทันที">
                                <svg viewBox="0 0 24 24" fill="var(--accent-color)" width="18" height="18"><path d="M8 5v14l11-7z"/></svg>
                            </button>
                            <button class="btn-delete-song" title="ลบ">
                                <svg viewBox="0 0 24 24" fill="none" stroke="#ff4d4d" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                    </div>
                `;

                div.querySelector('.btn-play-now').onclick = (e) => {
                    e.stopPropagation();
                    if (!currentRoomId) return alert('Room not ready');
                    socket.emit('play-specific', { roomId: currentRoomId, index });
                };

                div.querySelector('.btn-delete-song').onclick = (e) => {
                    e.stopPropagation();
                    if (!currentRoomId) return alert('Room not ready');
                    socket.emit('remove-from-queue', { roomId: currentRoomId, index });
                };

                queueListDisplay.appendChild(div);
            });

            // If nothing is playing and we have items, request next
            if (!currentSong && queue.length > 0) {
                socket.emit('request-next', currentRoomId);
            }
        });

        socket.on('play-song', (song) => {
            if (song) {
                currentSong = song;
                document.getElementById('current-title').innerText = song.title;
                document.getElementById('current-artist').innerText = song.author;
                player.loadVideoById(song.id);
            } else {
                currentSong = null;
                document.getElementById('current-title').innerText = "Welcome to Karaoke";
                document.getElementById('current-artist').innerText = "Scan QR to start singing!";
            }
        });

        socket.on('force-skip', () => {
            socket.emit('request-next', currentRoomId);
        });

        socket.on('toggle-play', () => {
            if (player) {
                if (isPlaying) player.pauseVideo();
                else player.playVideo();
            }
        });

        socket.on('set-volume', (volume) => {
            if (player) {
                player.setVolume(volume);
                document.getElementById('volume-range').value = volume;
            }
        });

        function showScore() {
            const score = Math.floor(Math.random() * 26) + 75; // 75-100
            document.getElementById('final-score').innerText = score;
            const overlay = document.getElementById('score-overlay');
            overlay.style.display = 'flex';

            setTimeout(() => {
                overlay.style.display = 'none';
                socket.emit('request-next', currentRoomId);
            }, 5000);
        }

        // Auto-hide controls after 5 seconds of no mouse movement (fullscreen only)
        let hideControlsTimeout;
        const playerControls = document.querySelector('.player-controls');
        const fullscreenPlayer = document.querySelector('.fullscreen-player');

        function isFullscreen() {
            return !!(document.fullscreenElement || document.mozFullScreenElement ||
                     document.webkitFullscreenElement || document.msFullscreenElement);
        }

        function showControls() {
            playerControls.classList.remove('hidden');
            fullscreenPlayer.style.cursor = 'default';
            clearTimeout(hideControlsTimeout);

            // Only auto-hide in fullscreen mode
            if (isFullscreen()) {
                hideControlsTimeout = setTimeout(hideControls, 5000);
            }
        }

        function hideControls() {
            // Only hide in fullscreen mode
            if (!isFullscreen()) {
                playerControls.classList.remove('hidden');
                fullscreenPlayer.style.cursor = 'default';
                return;
            }

            // Don't hide if a modal is open or side panel is active
            const searchModal = document.getElementById('search-modal');
            const remoteModal = document.getElementById('remote-modal');
            const sidePanel = document.getElementById('side-panel');

            if (searchModal.classList.contains('active') ||
                remoteModal.classList.contains('active') ||
                sidePanel.classList.contains('active')) {
                return;
            }

            playerControls.classList.add('hidden');
            fullscreenPlayer.style.cursor = 'none';
        }

        // Mouse move listener
        fullscreenPlayer.addEventListener('mousemove', showControls);

        // Keep controls visible when hovering over them
        playerControls.addEventListener('mouseenter', () => {
            clearTimeout(hideControlsTimeout);
        });

        playerControls.addEventListener('mouseleave', () => {
            if (isFullscreen()) {
                hideControlsTimeout = setTimeout(hideControls, 5000);
            }
        });

        // Show controls when exiting fullscreen
        document.addEventListener('fullscreenchange', () => {
            if (!isFullscreen()) {
                showControls();
            }
        });
        document.addEventListener('webkitfullscreenchange', () => {
            if (!isFullscreen()) {
                showControls();
            }
        });
    </script>
</body>

</html>