<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DID Remote</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body class="remote-page-v2">
    <!-- Top Brand Bar -->
    <div class="remote-brand-bar">
        <div class="brand-logo">üé§ <span>Karaoke</span></div>
        <button class="btn-share-icon" onclick="openShareModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                <polyline points="16,6 12,2 8,6"></polyline>
                <line x1="12" y1="2" x2="12" y2="15"></line>
            </svg>
        </button>
    </div>

    <div class="remote-main-content">
        <!-- Title & Status -->
        <div class="remote-title-section">
            <h1>DID Remote</h1>
            <p class="user-display" onclick="showNameModal()" style="cursor: pointer;">
                ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: <span id="user-name-display">-</span> ‚úèÔ∏è
            </p>
            <div class="connection-badge">
                <span class="dot"></span>
                <span>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß</span>
            </div>
        </div>

        <!-- Now Playing Card -->
        <div class="np-card-v2">
            <div class="np-card-header">
                <img id="np-thumb" src="https://via.placeholder.com/80x80" class="np-thumb-v2">
                <div class="np-meta">
                    <h3 id="np-title">Welcome to Karaoke</h3>
                    <p id="np-artist">Ready to sing!</p>
                </div>
            </div>
            <div class="np-progress-v2">
                <span id="np-current-time" class="time-label">0:00</span>
                <div class="progress-track">
                    <div id="np-progress-fill" class="progress-fill-v2"></div>
                </div>
                <span id="np-total-time" class="time-label">0:00</span>
            </div>
            <div class="np-controls">
                <button id="remote-play-pause" class="btn-play-main">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
                        <path d="M8 5v14l11-7z" id="play-icon-path" />
                    </svg>
                </button>
                <button id="remote-skip" class="btn-skip" onclick="confirmSkipSong()">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="22" height="22">
                        <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Volume Section -->
        <div class="volume-section-v2">
            <p class="section-title">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á</p>
            <div class="volume-row">
                <svg viewBox="0 0 24 24" fill="rgba(255,255,255,0.6)" width="20" height="20">
                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z" />
                </svg>
                <input type="range" id="remote-volume" min="0" max="100" value="100">
                <span id="volume-value" class="volume-number">100</span>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section-v2">
            <div class="search-header">
                <p class="section-title">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏•‡∏á</p>
                <label class="toggle-compact">
                    <span>‡∏Ñ‡πâ‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≤‡∏£‡∏≤‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞</span>
                    <input type="checkbox" id="remote-karaoke-filter-toggle" checked>
                    <span class="toggle-dot"></span>
                </label>
            </div>
            <div class="search-box-v2">
                <input type="text" id="remote-search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏•‡∏á...">
                <button class="btn-clear-search" id="clear-remote-search-btn" onclick="clearRemoteSearchInput()"
                    style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="16"
                        height="16">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div id="remote-results-overlay" class="results-overlay-v2">
                <div id="remote-results-list" class="results-list-v2"></div>
            </div>
        </div>

        <!-- Queue Section -->
        <div class="queue-section-v2">
            <div class="queue-header">
                <p class="section-title">‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏û‡∏•‡∏á (<span id="queue-count-text">0</span>)</p>
                <!-- <button class="btn-clear-queue" onclick="clearQueueRemote()">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß</button> -->
            </div>
            <div id="remote-queue-list" class="queue-list-v2">
                <!-- Queue items -->
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Share Modal -->
    <div id="share-modal" class="search-modal">
        <div class="modal-content remote-modal-content">
            <div class="modal-header">
                <h3>‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏µ‡πÇ‡∏°‡∏ó</h3>
                <button class="btn-close" onclick="closeShareModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"
                        stroke-linejoin="round" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <p class="remote-hint">‡πÅ‡∏ä‡∏£‡πå QR Code ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á!</p>

            <div class="remote-qr-container">
                <div id="share-qrcode"></div>
            </div>

            <div class="remote-info-grid">
                <div class="info-item">
                    <label>‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á</label>
                    <span id="share-room-id" class="neon-text-cyan">------</span>
                </div>
            </div>

            <div class="remote-link-section">
                <label>‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á</label>
                <div class="link-input-group">
                    <input type="text" id="share-link-input" readonly value="">
                    <button class="btn-copy-link" onclick="copyShareLink()">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
                </div>
            </div>

            <div class="remote-modal-footer">
                <button class="btn-footer-gray" onclick="closeShareModal()">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <!-- Name Input Modal -->
    <div id="name-modal" class="name-modal">
        <div class="name-modal-content">
            <div class="name-modal-icon">üé§</div>
            <h3>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö!</h3>
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Remote</p>
            <input type="text" id="user-name-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..." maxlength="20">
            <button id="confirm-name-btn" class="btn-confirm-name">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="confirm-modal">
        <div class="confirm-modal-content">
            <div class="confirm-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" width="48" height="48">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
            </div>
            <h3 id="confirm-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
            <p id="confirm-message">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
            <div class="confirm-buttons">
                <button class="btn-confirm-cancel" onclick="closeConfirmModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn-confirm-ok" id="confirm-ok-btn">‡∏ï‡∏Å‡∏•‡∏á</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');

        let isPlaying = false;
        let userName = localStorage.getItem('remoteUserName') || '';
        let shareQRGenerated = false;
        let currentQueueRemote = [];

        // Share Modal Functions
        function openShareModal() {
            const modal = document.getElementById('share-modal');
            modal.classList.add('active');

            // Generate QR code if not already done
            if (!shareQRGenerated && roomId) {
                const remoteUrl = `${window.location.origin}/remote.html?room=${roomId}`;
                const qrContainer = document.getElementById('share-qrcode');
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: remoteUrl,
                    width: 200,
                    height: 200,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.L
                });

                document.getElementById('share-room-id').innerText = roomId;
                document.getElementById('share-link-input').value = remoteUrl;
                shareQRGenerated = true;
            }
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.remove('active');
        }

        function copyShareLink() {
            const linkInput = document.getElementById('share-link-input');
            linkInput.select();
            document.execCommand('copy');
            showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß!');
        }

        // Show name modal
        function showNameModal() {
            const input = document.getElementById('user-name-input');
            if (userName) {
                input.value = userName;
            }
            document.getElementById('name-modal').classList.add('active');
            input.focus();
            input.select();
        }

        function confirmName() {
            const nameInput = document.getElementById('user-name-input');
            const name = nameInput.value.trim();
            if (name.length < 1) {
                nameInput.style.borderColor = '#ff4d4d';
                nameInput.placeholder = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠!';
                return;
            }
            userName = name;
            localStorage.setItem('remoteUserName', userName);
            document.getElementById('name-modal').classList.remove('active');
            document.getElementById('user-name-display').innerText = userName;

            // Now join the room
            if (roomId) {
                socket.emit('join-room', roomId);
            }
        }

        // Confirm Modal Functions
        let confirmCallback = null;

        function showConfirmModal(title, message, callback) {
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-message').innerText = message;
            confirmCallback = callback;
            document.getElementById('confirm-modal').classList.add('active');
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.remove('active');
            confirmCallback = null;
        }

        document.getElementById('confirm-ok-btn').onclick = () => {
            if (confirmCallback) confirmCallback();
            closeConfirmModal();
        };

        // Skip song with confirmation
        function confirmSkipSong() {
            if (currentQueueRemote.length === 0) {
                showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏•‡∏á‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß');
                return;
            }
            showConfirmModal(
                '‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏û‡∏•‡∏á',
                '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏û‡∏•‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                () => {
                    socket.emit('skip-song', roomId);
                }
            );
        }

        // Display username on load
        if (userName) {
            document.getElementById('user-name-display').innerText = userName;
        }

        document.getElementById('confirm-name-btn').onclick = confirmName;
        document.getElementById('user-name-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') confirmName();
        });

        // Check if name exists, if not show modal, else join room
        if (roomId) {
            if (!userName) {
                showNameModal();
            } else {
                socket.emit('join-room', roomId);
            }
        } else {
            alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
        }

        // Handle initial sync when joining room
        socket.on('room-joined', ({ queue, currentSong }) => {
            console.log('Room joined, syncing initial data...');
            updateQueueUI(queue);
            updateNowPlaying(currentSong);
        });

        // Handle full sync response
        socket.on('full-sync', ({ queue, currentSong }) => {
            console.log('Full sync received');
            updateQueueUI(queue);
            updateNowPlaying(currentSong);
        });

        // Periodic sync every 5 seconds to ensure data consistency
        setInterval(() => {
            if (roomId) {
                socket.emit('request-sync', roomId);
            }
        }, 5000);

        // Helper function to update now playing display
        function updateNowPlaying(song) {
            const title = document.getElementById('np-title');
            const artist = document.getElementById('np-artist');
            const thumb = document.getElementById('np-thumb');

            if (song) {
                title.innerText = song.title;
                artist.innerText = song.author;
                thumb.src = song.thumbnail;
            } else {
                title.innerText = "Welcome to Karaoke";
                artist.innerText = "Ready to sing? Scan QR or Add song!";
                thumb.src = "https://via.placeholder.com/120x68";
            }
        }

        // Helper function to update queue UI
        function updateQueueUI(queue) {
            currentQueueRemote = queue;
            const queueList = document.getElementById('remote-queue-list');
            const queueCount = document.getElementById('queue-count-text');
            queueCount.innerText = queue.length;
            queueList.innerHTML = '';

            queue.forEach((song, index) => {
                const card = document.createElement('div');
                card.className = 'queue-item-v2';
                card.innerHTML = `
                    <span class="qi-num">${index + 1}</span>
                    <img src="${song.thumbnail}" class="qi-thumb-v2">
                    <div class="qi-meta">
                        <h4>${song.title}</h4>
                        <p>${song.author}</p>
                        ${song.addedBy ? `<span class="qi-by">${song.addedBy}</span>` : ''}
                    </div>
                    <div class="qi-btns">
                        <button class="qi-play" onclick="playSpecificRemote(${index})">‚ñ∂</button>
                        <button class="qi-del" onclick="removeSpecificRemote(${index})">‚úï</button>
                    </div>
                `;
                queueList.appendChild(card);
            });
        }

        // Search Logic
        let searchTimeout;
        let currentSearchQuery = '';
        let currentSearchPage = 1;
        const searchInput = document.getElementById('remote-search-input');
        const clearRemoteSearchBtnEl = document.getElementById('clear-remote-search-btn');
        const resultsOverlay = document.getElementById('remote-results-overlay');
        const resultsList = document.getElementById('remote-results-list');

        function clearRemoteSearchInput() {
            searchInput.value = '';
            clearRemoteSearchBtnEl.style.display = 'none';
            resultsOverlay.classList.remove('active');
            searchInput.focus();
        }

        // Toggle switch listener - focus input and re-search
        document.getElementById('remote-karaoke-filter-toggle').addEventListener('change', async () => {
            searchInput.focus();
            const query = searchInput.value.trim();
            if (query.length >= 2) {
                resultsOverlay.classList.add('active');
                resultsList.innerHTML = '<div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</div>';
                currentSearchQuery = query;
                currentSearchPage = 1;
                try {
                    const karaokeOnly = document.getElementById('remote-karaoke-filter-toggle').checked;
                    const res = await fetch(`/api/search?q=${encodeURIComponent(query)}&page=1&karaokeOnly=${karaokeOnly}`);
                    const songs = await res.json();
                    displaySearchCard(songs, false);
                } catch (err) {
                    resultsList.innerHTML = '<div class="error">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</div>';
                }
            }
        });

        searchInput.addEventListener('input', () => {
            clearRemoteSearchBtnEl.style.display = searchInput.value.length > 0 ? 'flex' : 'none';
            clearTimeout(searchTimeout);
            const query = searchInput.value;
            if (query.length < 2) {
                resultsOverlay.classList.remove('active');
                return;
            }

            searchTimeout = setTimeout(async () => {
                resultsOverlay.classList.add('active');
                resultsList.innerHTML = '<div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</div>';
                currentSearchQuery = query;
                currentSearchPage = 1;
                try {
                    const karaokeOnly = document.getElementById('remote-karaoke-filter-toggle').checked;
                    const res = await fetch(`/api/search?q=${encodeURIComponent(query)}&page=1&karaokeOnly=${karaokeOnly}`);
                    const songs = await res.json();
                    displaySearchCard(songs, false);
                } catch (err) {
                    resultsList.innerHTML = '<div class="error">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</div>';
                }
            }, 500);
        });

        async function loadMoreSearch() {
            currentSearchPage++;
            const loadMoreBtn = document.querySelector('.btn-load-more-remote');
            if (loadMoreBtn) loadMoreBtn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';

            try {
                const karaokeOnly = document.getElementById('remote-karaoke-filter-toggle').checked;
                const res = await fetch(`/api/search?q=${encodeURIComponent(currentSearchQuery)}&page=${currentSearchPage}&karaokeOnly=${karaokeOnly}`);
                const songs = await res.json();
                displaySearchCard(songs, true);
            } catch (err) {
                console.error("Load more failed", err);
            }
        }

        function displaySearchCard(songs, append = false) {
            if (!append) resultsList.innerHTML = '';

            // Remove existing load more button if any
            const oldBtn = document.querySelector('.btn-load-more-remote');
            if (oldBtn) oldBtn.remove();

            if (!append && songs.length === 0) {
                resultsList.innerHTML = '<div class="empty">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏û‡∏•‡∏á</div>';
                return;
            }

            songs.forEach(song => {
                const card = document.createElement('div');
                card.className = 'remote-song-card';
                card.innerHTML = `
                    <img src="${song.thumbnail}" class="rs-thumb">
                    <div class="rs-info">
                        <h4>${song.title}</h4>
                        <p>${song.author}</p>
                    </div>
                    <button class="btn-add-remote">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                `;
                card.querySelector('.btn-add-remote').onclick = (e) => {
                    const btn = e.currentTarget;
                    const originalText = btn.innerHTML;

                    // Add song with user name
                    const songWithUser = { ...song, addedBy: userName };
                    socket.emit('add-to-queue', { roomId, song: songWithUser });

                    // Button feedback
                    btn.innerHTML = '‚úì ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß';
                    btn.classList.add('added');
                    btn.disabled = true;

                    // Show toast
                    showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏° "${song.title.substring(0, 30)}..." ‡∏•‡∏á‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß`);

                    // Reset button after 1.5 seconds
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('added');
                        btn.disabled = false;
                    }, 1500);
                };
                resultsList.appendChild(card);
            });

            if (songs.length >= 5) {
                const loadMoreBtn = document.createElement('button');
                loadMoreBtn.className = 'btn-load-more-remote';
                loadMoreBtn.innerText = '‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°';
                loadMoreBtn.onclick = loadMoreSearch;
                resultsList.appendChild(loadMoreBtn);
            }
        }

        // Close results when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !resultsOverlay.contains(e.target)) {
                resultsOverlay.classList.remove('active');
            }
        });

        // Controls
        document.getElementById('remote-play-pause').onclick = () => {
            socket.emit('toggle-play', roomId);
        };

        // Skip is handled by onclick="confirmSkipSong()" in HTML

        const volRange = document.getElementById('remote-volume');
        const volVal = document.getElementById('volume-value');
        volRange.oninput = () => {
            volVal.innerText = volRange.value;
            socket.emit('set-volume', { roomId, volume: volRange.value });
        };

        function clearQueueRemote() {
            showConfirmModal(
                '‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏û‡∏•‡∏á',
                '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                () => {
                    socket.emit('clear-queue', roomId);
                }
            );
        }

        // Socket Events - Real-time updates
        socket.on('queue-updated', (queue) => {
            updateQueueUI(queue);
        });

        window.playSpecificRemote = (index) => {
            socket.emit('play-specific', { roomId, index });
        };

        window.removeSpecificRemote = (index) => {
            socket.emit('remove-from-queue', { roomId, index });
        };

        socket.on('play-song', (song) => {
            updateNowPlaying(song);
        });

        // Sync with playback state from server
        socket.on('player-state', ({ isPlaying: playing, volume, currentTime, duration }) => {
            isPlaying = playing;
            const playBtn = document.getElementById('remote-play-pause');
            if (isPlaying) {
                playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" width="32" height="32"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
            } else {
                playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" width="32" height="32"><path d="M8 5v14l11-7z"/></svg>';
            }

            if (volume !== undefined) {
                volRange.value = volume;
                volVal.innerText = volume;
            }

            if (duration > 0) {
                const percent = (currentTime / duration) * 100;
                document.getElementById('np-progress-fill').style.width = percent + '%';
                document.getElementById('np-current-time').innerText = formatTime(currentTime);
                document.getElementById('np-total-time').innerText = formatTime(duration);
            }
        });

        function formatTime(s) {
            const min = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }

        // Toast notification function
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2500);
        }
    </script>
</body>

</html>