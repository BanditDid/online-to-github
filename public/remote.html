<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>แหกปาก Remote</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>

<body class="remote-page">
    <div class="remote-container">
        <!-- Header -->
        <header class="remote-header">
            <h2>แหกปาก Remote</h2>
            <div id="connection-status" class="status-indicator">
                <span class="dot"></span>
                <span class="status-text">เชื่อมต่อแล้ว</span>
            </div>
        </header>

        <!-- Now Playing Card -->
        <section class="now-playing-section">
            <p class="section-label">กำลังเล่น</p>
            <div class="now-playing-card">
                <div class="np-info">
                    <img id="np-thumb" src="https://via.placeholder.com/120x68" class="np-thumb">
                    <div class="np-details">
                        <h4 id="np-title">Welcome to Karaoke</h4>
                        <p id="np-artist">Ready to sing? Scan QR or Add song!</p>
                    </div>
                </div>
                <div class="np-progress-area">
                    <div class="progress-bar-container">
                        <div id="np-progress-fill" class="progress-fill"></div>
                    </div>
                    <div class="time-info">
                        <span id="np-current-time">0:00</span>
                        <span id="np-total-time">0:00</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Playback Controls -->
        <section class="playback-controls">
            <button id="remote-play-pause" class="btn-play-pause-main">
                <svg viewBox="0 0 24 24" fill="currentColor" width="32" height="32">
                    <path d="M8 5v14l11-7z" id="play-icon-path" />
                </svg>
            </button>
            <button id="remote-skip" class="btn-skip-sub">
                <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                    <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z" />
                </svg>
            </button>
        </section>

        <!-- Volume Control -->
        <section class="volume-control">
            <p class="section-label">ระดับเสียง</p>
            <div class="volume-card">
                <svg viewBox="0 0 24 24" fill="white" width="18" height="18">
                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z" />
                </svg>
                <input type="range" id="remote-volume" min="0" max="100" value="100">
                <span id="volume-value">100</span>
            </div>
        </section>

        <!-- Search Section -->
        <section class="remote-search-section">
            <p class="section-label">ค้นหาเพลง</p>
            <div class="search-input-group">
                <input type="text" id="remote-search-input" placeholder="ค้นหาเพลงคาราโอเกะ...">
            </div>
            <!-- Search Results Inline -->
            <div id="remote-results-overlay" class="results-overlay">
                <div id="remote-results-list" class="remote-results-list"></div>
            </div>
        </section>

        <!-- Queue Section -->
        <section class="remote-queue-section">
            <div class="section-header">
                <p class="section-label">คิวเพลง (<span id="queue-count-text">0</span>)</p>
                <button class="btn-clear-remote" onclick="clearQueueRemote()">ล้างคิว</button>
            </div>
            <div id="remote-queue-list" class="remote-queue-list">
                <!-- Queue items here -->
            </div>
        </section>
    </div>

    <script>
        const socket = io();
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');

        let isPlaying = false;

        if (roomId) {
            socket.emit('join-room', roomId);
        } else {
            alert("ไม่พบรหัสห้อง กรุณาสแกน QR Code ใหม่อีกครั้ง");
        }

        // Search Logic
        let searchTimeout;
        let currentSearchQuery = '';
        let currentSearchPage = 1;
        const searchInput = document.getElementById('remote-search-input');
        const resultsOverlay = document.getElementById('remote-results-overlay');
        const resultsList = document.getElementById('remote-results-list');

        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            const query = searchInput.value;
            if (query.length < 2) {
                resultsOverlay.classList.remove('active');
                return;
            }

            searchTimeout = setTimeout(async () => {
                resultsOverlay.classList.add('active');
                resultsList.innerHTML = '<div class="loading">กำลังค้นหา...</div>';
                currentSearchQuery = query;
                currentSearchPage = 1;
                try {
                    const res = await fetch(`/api/search?q=${encodeURIComponent(query)}&page=1`);
                    const songs = await res.json();
                    displaySearchCard(songs, false);
                } catch (err) {
                    resultsList.innerHTML = '<div class="error">ค้นหาล้มเหลว</div>';
                }
            }, 500);
        });

        async function loadMoreSearch() {
            currentSearchPage++;
            const loadMoreBtn = document.querySelector('.btn-load-more-remote');
            if (loadMoreBtn) loadMoreBtn.innerText = 'กำลังโหลด...';

            try {
                const res = await fetch(`/api/search?q=${encodeURIComponent(currentSearchQuery)}&page=${currentSearchPage}`);
                const songs = await res.json();
                displaySearchCard(songs, true);
            } catch (err) {
                console.error("Load more failed", err);
            }
        }

        function displaySearchCard(songs, append = false) {
            if (!append) resultsList.innerHTML = '';

            // Remove existing load more button if any
            const oldBtn = document.querySelector('.btn-load-more-remote');
            if (oldBtn) oldBtn.remove();

            if (!append && songs.length === 0) {
                resultsList.innerHTML = '<div class="empty">ไม่พบเพลง</div>';
                return;
            }

            songs.forEach(song => {
                const card = document.createElement('div');
                card.className = 'remote-song-card';
                card.innerHTML = `
                    <img src="${song.thumbnail}" class="rs-thumb">
                    <div class="rs-info">
                        <h4>${song.title}</h4>
                        <p>${song.author}</p>
                    </div>
                    <button class="btn-add-remote">+ เพิ่ม</button>
                `;
                card.querySelector('.btn-add-remote').onclick = () => {
                    socket.emit('add-to-queue', { roomId, song });
                    searchInput.value = '';
                    resultsOverlay.classList.remove('active');
                };
                resultsList.appendChild(card);
            });

            if (songs.length >= 5) {
                const loadMoreBtn = document.createElement('button');
                loadMoreBtn.className = 'btn-load-more-remote';
                loadMoreBtn.innerText = 'โหลดเพิ่มเติม';
                loadMoreBtn.onclick = loadMoreSearch;
                resultsList.appendChild(loadMoreBtn);
            }
        }

        // Close results when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !resultsOverlay.contains(e.target)) {
                resultsOverlay.classList.remove('active');
            }
        });

        // Controls
        document.getElementById('remote-play-pause').onclick = () => {
            socket.emit('toggle-play', roomId);
        };

        document.getElementById('remote-skip').onclick = () => {
            if (confirm('ข้ามเพลงนี้ใช่หรือไม่?')) {
                socket.emit('skip-song', roomId);
            }
        };

        const volRange = document.getElementById('remote-volume');
        const volVal = document.getElementById('volume-value');
        volRange.oninput = () => {
            volVal.innerText = volRange.value;
            socket.emit('set-volume', { roomId, volume: volRange.value });
        };

        function clearQueueRemote() {
            if (confirm('คุณต้องการล้างคิวเพลงทั้งหมดหรือไม่?')) {
                socket.emit('clear-queue', roomId);
            }
        }

        // Socket Events
        socket.on('queue-updated', (queue) => {
            const queueList = document.getElementById('remote-queue-list');
            const queueCount = document.getElementById('queue-count-text');
            queueCount.innerText = queue.length;
            queueList.innerHTML = '';

            queue.forEach((song, index) => {
                const card = document.createElement('div');
                card.className = 'remote-queue-item';
                card.innerHTML = `
                    <div class="qi-inner">
                        <span class="qi-index">${index + 1}</span>
                        <img src="${song.thumbnail}" class="qi-thumb">
                        <div class="qi-info">
                            <h4>${song.title}</h4>
                            <p>${song.author}</p>
                        </div>
                        <div class="qi-actions">
                            <button class="btn-qi-play" onclick="playSpecificRemote(${index})">
                                <svg viewBox="0 0 24 24" fill="var(--accent-color)" width="18" height="18"><path d="M8 5v14l11-7z"/></svg>
                            </button>
                            <button class="btn-qi-delete" onclick="removeSpecificRemote(${index})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="#ff4d4d" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                    </div>
                `;
                queueList.appendChild(card);
            });
        });

        window.playSpecificRemote = (index) => {
            socket.emit('play-specific', { roomId, index });
        };

        window.removeSpecificRemote = (index) => {
            socket.emit('remove-from-queue', { roomId, index });
        };

        socket.on('play-song', (song) => {
            const title = document.getElementById('np-title');
            const artist = document.getElementById('np-artist');
            const thumb = document.getElementById('np-thumb');

            if (song) {
                title.innerText = song.title;
                artist.innerText = song.author;
                thumb.src = song.thumbnail;
            } else {
                title.innerText = "Welcome to Karaoke";
                artist.innerText = "Ready to sing? Scan QR or Add song!";
                thumb.src = "https://via.placeholder.com/120x68";
            }
        });

        // Sync with playback state from server
        socket.on('player-state', ({ isPlaying: playing, volume, currentTime, duration }) => {
            isPlaying = playing;
            const playBtn = document.getElementById('remote-play-pause');
            if (isPlaying) {
                playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" width="32" height="32"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
            } else {
                playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" width="32" height="32"><path d="M8 5v14l11-7z"/></svg>';
            }

            if (volume !== undefined) {
                volRange.value = volume;
                volVal.innerText = volume;
            }

            if (duration > 0) {
                const percent = (currentTime / duration) * 100;
                document.getElementById('np-progress-fill').style.width = percent + '%';
                document.getElementById('np-current-time').innerText = formatTime(currentTime);
                document.getElementById('np-total-time').innerText = formatTime(duration);
            }
        });

        function formatTime(s) {
            const min = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }
    </script>
</body>

</html>